version: "3.8"

services:
  omniparser-gradio:
    build:
      context: .
      dockerfile: Dockerfile
    image: omniparser:v2
    container_name: omniparser-gradio
    environment:
      - OMNIPARSER_MODE=gradio
      - OMNIPARSER_BATCH_SIZE=64
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7861
      - GRADIO_SHARE=false
      - NVIDIA_VISIBLE_DEVICES=all
    ports:
      - "7861:7861"
    volumes:
      - ./weights:/app/weights:ro
      - omniparser-ocr-cache:/app/ocr_cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    profiles:
      - gradio
      - all

  omniparser-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: omniparser:v2
    container_name: omniparser-server
    environment:
      - OMNIPARSER_MODE=server
      - OMNIPARSER_HOST=0.0.0.0
      - OMNIPARSER_PORT=8000
      - OMNIPARSER_BATCH_SIZE=64
      - NVIDIA_VISIBLE_DEVICES=all
    ports:
      - "8000:8000"
    volumes:
      - ./weights:/app/weights:ro
      - omniparser-ocr-cache:/app/ocr_cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    profiles:
      - server
      - all

volumes:
  omniparser-ocr-cache:
    name: omniparser-ocr-cache
